---
title: "Minnesota State High School Boys Hockey Predictions"
author: "~"
date: 2018-03-03
tags: ["Hockey", "Elo", "R"]
header:
  image: "headers/km-klemencic-header.jpg"
  caption: "Image Credit: A flickr photo by K.M. Klemencic"
---



<p>The state high school boys hockey tournament, scheduled for March 7–10, is one of the premiere sporting events in the state of Minnesota. According to <a href="https://en.wikipedia.org/wiki/High_school_boys_ice_hockey_in_Minnesota">Wikipedia</a>, this event has drawn over 100,000 spectators 22 times in its history, eclipsing 135,000 spectoators in 2015. Many national caliber players played high school hockey in Minnesota, several taking part in the state tournament. Names like Neal Broten, Herb Brooks, and T. J. Oshie are alumni of state tournaments past.</p>
<p>Minnesota high school hockey teams are split into two classes based on school enrollment sizes; the largest 64 schools are classified as Class AA and the remainder are classified as Class A. Each of these classes are subdivided into eight sections. (Sections are based on a combination of school location and competitivness.)</p>
<p>This year’s state tournament features 16 teams (8 from Class A and 8 from Class AA) that qualified for the tournament by winning their section tournament. Within each class, the top five teams are seeded (ranked) by the coaches of the teams that qualified for the state tournament. The #4 and #5 seeds play each other and the remaining three teams in each class are assigned by lottery to play the #1, #2, and #3 seeded teams. The seeds in the 2018 tournament, announced on March 3, are:</p>
<table>
<caption><span id="tab:unnamed-chunk-1">Table 1: </span>Top eight seeds based on the 2018 state tournament bracket. The 6–8 seeds are based on the opponents the teams were assigned to in the lottery.</caption>
<thead>
<tr class="header">
<th align="center">Seed</th>
<th align="left">A</th>
<th align="left">AA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="left">Hermantown</td>
<td align="left">Minnetonka</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="left">Mahtomedi</td>
<td align="left">Edina</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="left">Orono</td>
<td align="left">Duluth East</td>
</tr>
<tr class="even">
<td align="center">4</td>
<td align="left">Alexandria</td>
<td align="left">St. Thomas Academy</td>
</tr>
<tr class="odd">
<td align="center">5</td>
<td align="left">Thief River Falls</td>
<td align="left">Centennial</td>
</tr>
<tr class="even">
<td align="center">6</td>
<td align="left">Litchfield/Dassel-Cokato</td>
<td align="left">St. Michael-Albertville (STMA)</td>
</tr>
<tr class="odd">
<td align="center">7</td>
<td align="left">Mankato East/Loyola</td>
<td align="left">Lakeville North</td>
</tr>
<tr class="even">
<td align="center">8</td>
<td align="left">Monticello</td>
<td align="left">Hill-Murray</td>
</tr>
</tbody>
</table>
<p>I wanted to make compute probabilities, à la fivethirtyeight, for which each team’s chances of winning the state tournament. The methodology I used to do this was:</p>
<ul>
<li>Use the regular season and section tournament game data to compute Elo ratings for all the teams.</li>
<li>Use these Elo rating to simulate 10,000 state tournament winners.</li>
<li>Each team’s probability of winning was then computed as the proportion of times that team won the tournament in the simulation.</li>
</ul>
<div id="scraping-the-game-level-data" class="section level2">
<h2>Scraping the Game-Level Data</h2>
<p>To begin, I had to obtain the game data for both the regular season and the section tournaments. <a href="http://www.mnhockeyhub.com/">MN Hockey Hub</a> is a website that has the results for all high school hockey games played in Minnesota. I used the <strong>rvest</strong> package to scrape these data. Unfortunately, MN Hockey Hub separates their regular season and section playoffs, so I had to run the scrape on each separately and then combine the data.</p>
<pre class="r"><code># Beginning and ending dates for regular season games
start = as.Date(&quot;2017/11/22&quot;, format = &quot;%Y/%m/%d&quot;)
end   = as.Date(&quot;2018/02/17&quot;,format=&quot;%Y/%m/%d&quot;)

# Create an empty list with 101 elements
results = rep(list(NA), 88) 

# Initialize values
theDate = start
i = 1

# Loop over dates
while (theDate &lt;= end){
  url = paste0(&quot;http://www.mnhockeyhub.com/schedule/day/league_instance/60876/&quot;,
               format(theDate,&quot;%Y/%m/%d&quot;),
              &quot;?subseason=434877&amp;referrer=3596811&quot;
               )
  
  results[[i]] = as.data.frame(
    url %&gt;% 
      read_html() %&gt;% 
      html_table()
    ) %&gt;% 
    mutate(date = theDate)
  theDate = theDate + 1 
  i = i + 1
}

## Scrape section games
start = as.Date(&quot;2018/02/17&quot;, format = &quot;%Y/%m/%d&quot;)
end   = as.Date(&quot;2018/03/02&quot;,format=&quot;%Y/%m/%d&quot;)
results2 = rep(list(NA), 14) 
theDate = start
i = 1

while (theDate &lt;= end){
  url = paste0(&quot;http://www.mnhockeyhub.com/schedule/day/league_instance/60876/&quot;,
               format(theDate,&quot;%Y/%m/%d&quot;),
               &quot;?subseason=486996&quot;
  )
  
  results2[[i]] = as.data.frame(
    url %&gt;% 
      read_html() %&gt;% 
      html_table()
  ) %&gt;% 
    mutate(date = theDate)
  theDate = theDate + 1 
  i = i + 1
}</code></pre>
<p>I then took these scraped data, and put them into a dataframe using <code>do.call()</code> and formatted the data frame using <strong>dplyr</strong> functions.</p>
<pre class="r"><code># Transform lists to data frames
hockey_reg_season = do.call(rbind, results)
hockey_sections = do.call(rbind, results2)

# Format the data
library(dplyr)

hockey = rbind(hockey_reg_season, hockey_sections) %&gt;%
  select(date,
         home = Home,
         home_score = H,
         visitor = Visitor,
         visitor_score = V,
         location = Location
  ) %&gt;%
  mutate(
    home_score = as.integer(home_score),
    visitor_score = as.integer(visitor_score)
  ) %&gt;%
  tidyr::drop_na()</code></pre>
<p>At this point I did a data integrity check. The first thing I noticed was that there were games in the data on every day from the start of the regular season through the section playoffs. I knew somethibng was wrong as high school teams do not play games on Sundays or on holidays. In looking at those days, it turned out the web scraper just duplicated games from future days (e.g., there was no game on 12-25-2017, so it just skipped ahead to the next day a game was played, 12-26-2017, and put those games in the December 25th date. It then also put them in the 12-26-2017 date as well.) Rather than try to program a solution in R, I outputted the data to a CSV file and manually removed the few dates that there were no games played.</p>
<pre><code>## # A tibble: 2,047 x 7
##    date   home    home_score visitor   visitor_score location      season 
##    &lt;chr&gt;  &lt;chr&gt;        &lt;int&gt; &lt;chr&gt;             &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;  
##  1 11/22… Anoka            4 Rogers                1 Anoka Arena,… Regula…
##  2 11/22… Provid…          2 Spring L…             3 Plymouth Ice… Regula…
##  3 11/22… St. Pa…          3 Blooming…             2 Drake Arena   Regula…
##  4 11/24… Armstr…         10 Proctor               0 Chisago Lake… Regula…
##  5 11/24… Baldwi…          2 St. Paul…             4 Amery Ice Ar… Regula…
##  6 11/24… Eastvi…          5 Park of …             3 Apple Valley… Regula…
##  7 11/24… Orono            5 East Gra…             3 Orono Ice Ar… Regula…
##  8 11/24… Greenw…          5 Mound We…             3 Hodgins-Bera… Regula…
##  9 11/24… Minnes…          2 North Br…             8 Turkey Tourn… Regula…
## 10 11/24… Edina            7 Holy Fam…             0 Plymouth Ice… Regula…
## # ... with 2,037 more rows</code></pre>
</div>
<div id="compute-elo-ratings" class="section level2">
<h2>Compute Elo Ratings</h2>
<p>After scraping and formatting the data, I used the <strong>elo</strong> package to compute Elo ratings. The <a href="https://cran.r-project.org/web/packages/elo/vignettes/elo.html">package vignette</a> is helpful for understanding the syntax used to fit different Elo models. The <code>elo.run()</code> function initializes each team’s Elo rating to 1500, and then updates each team’s rating after every game played based on whether the team won or lost. In the model I fitted, I also accounted for the score differential.</p>
<p>The rate at which each team’s Elo rating changes based on a win or loss is referred to as the <span class="math inline">\(K\)</span>-factor. Larger values of <span class="math inline">\(K\)</span> have a bigger change in the Elo rating. I didn’t think that result of any one hockey game should impact the rating too greatly, so I chose a <span class="math inline">\(K\)</span>-factor of 15. Rather than set this to a constant value for each game, the model I used adjusted this factor based on the score differential, mathematically,</p>
<p><span class="math display">\[
15 \times \ln(| \mathrm{Score}_{\mathrm{Home}} - \mathrm{Score}_{\mathrm{Visitor}} |) + 1.
\]</span></p>
<p>Taking the natural logarithm helps to lessen the impact of games where one team runs up the score on another team.</p>
<p>I also considered whether Elo ratings needed to take into account a home ice advantage. The empirical data indicated that the home team in the 2017–2018 season did not have an advantage, winning about 48% of the games played. Thus, ultimately, I decided not to include any home ice advantage (or disadvantage).</p>
<p>Since during the regular season teams play games with other teams that are in other classes, I opted to fit one model taht included teams from both classes rather than fit the model within class.</p>
<pre class="r"><code>library(elo)
elo_reg_season = elo.run(score(home_score, visitor_score) ~ home + visitor +
                    k(15*log(abs(home_score - visitor_score) + 1)), data = hockey)</code></pre>
<p>The final Elo ratings and rankings for teams that qualified for the state tournament are shown below.</p>
<table>
<caption><span id="tab:unnamed-chunk-6">Table 2: </span>Elo ratings and rankings for the eight Class A teams that qualified for the state tournament.</caption>
<thead>
<tr class="header">
<th align="left">Team</th>
<th align="center">Elo</th>
<th align="center">Rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Hermantown</td>
<td align="center">1639.196</td>
<td align="center">11</td>
</tr>
<tr class="even">
<td align="left">Mahtomedi</td>
<td align="center">1624.538</td>
<td align="center">17</td>
</tr>
<tr class="odd">
<td align="left">Orono</td>
<td align="center">1609.513</td>
<td align="center">24</td>
</tr>
<tr class="even">
<td align="left">Monticello</td>
<td align="center">1587.179</td>
<td align="center">31</td>
</tr>
<tr class="odd">
<td align="left">Alexandria</td>
<td align="center">1571.198</td>
<td align="center">39</td>
</tr>
<tr class="even">
<td align="left">Thief River Falls</td>
<td align="center">1562.803</td>
<td align="center">42</td>
</tr>
<tr class="odd">
<td align="left">Mankato East</td>
<td align="center">1551.141</td>
<td align="center">48</td>
</tr>
<tr class="even">
<td align="left">Litchfield/Dassel-Cokato</td>
<td align="center">1530.773</td>
<td align="center">60</td>
</tr>
</tbody>
</table>
<table>
<caption><span id="tab:unnamed-chunk-7">Table 3: </span>Elo ratings and rankings for the eight Class AA teams that qualified for the state tournament.</caption>
<thead>
<tr class="header">
<th align="left">Team</th>
<th align="center">Elo</th>
<th align="center">Rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Edina</td>
<td align="center">1718.589</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="left">St. Thomas Academy</td>
<td align="center">1716.570</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="left">Minnetonka</td>
<td align="center">1693.757</td>
<td align="center">3</td>
</tr>
<tr class="even">
<td align="left">Duluth East</td>
<td align="center">1691.315</td>
<td align="center">4</td>
</tr>
<tr class="odd">
<td align="left">STMA</td>
<td align="center">1655.561</td>
<td align="center">7</td>
</tr>
<tr class="even">
<td align="left">Centennial</td>
<td align="center">1625.291</td>
<td align="center">16</td>
</tr>
<tr class="odd">
<td align="left">Lakeville North</td>
<td align="center">1578.414</td>
<td align="center">38</td>
</tr>
<tr class="even">
<td align="left">Hill-Murray</td>
<td align="center">1557.501</td>
<td align="center">46</td>
</tr>
</tbody>
</table>
<p>Comparing these to the actual tournament seeds, we see several differences in the top four seeds. In Class A, the coaches included Alexandria in the top five, while our Elo model put Monticello in the top four. In Class AA, the Elo model and the coaches selected the same top five teams, but had a different rank ordering for those teams. There are also some ranking differences between the coaches picks and our Elo model for the other teams.</p>
</div>
<div id="simulate-the-state-tournament" class="section level2">
<h2>Simulate the State Tournament</h2>
<p>We can now use these Elo ratings to determine the probability that one team would beat another. For example, in the Class A quarterfinal game between Hermantown (#1) and Monticello (#8), Hermantown’s probability of beating Monticello is 0.574 .</p>
<pre class="r"><code>predict(elo_reg_season, data.frame(home = &quot;Hermantown&quot;, visitor = &quot;Monticello&quot;))</code></pre>
<pre><code>## [1] 0.574304</code></pre>
<p>I simulated the state tournament by using a random-number generator to determine the winner of each game. For instance, to simulate the Hermantown/Monticello game, I used the <code>runif()</code> function to generate a random number drawn from the uniform distribution between 0 and 1. If the result is less than or equal to 0.574, Hermantown is the winner; if not, Monticello wins. The syntax for simulating the Class A state tournament 10,000 times is below.</p>
<pre class="r"><code># Enter teams in rank order
team_1 = &quot;Hermantown&quot;
team_2 = &quot;Mahtomedi&quot;
team_3 = &quot;Orono&quot;
team_4 = &quot;Alexandria&quot;
team_5 = &quot;Thief River Falls&quot;
team_6 = &quot;Litchfield/Dassel-Cokato&quot;
team_7 = &quot;Mankato East&quot;
team_8 = &quot;Monticello&quot;

# Set up empty vector to store winner in
champion = rep(NA, 10000)


for(i in 1:10000){
  
  ### SIMULATE THE QUARTEFINALS
  
  # Predict Game 1 winner: team_1 vs. team_8
  p_game_1 = predict(elo_reg_season, data.frame(home = team_1, visitor = team_8))
  w_game_1 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_1, team_1, team_8)
  
  # Predict Game 2 winner: team_4 vs. team_4
  p_game_2 = predict(elo_reg_season, data.frame(home = team_4, visitor = team_5))
  w_game_2 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_2, team_4, team_5)
  
  # Predict Game 3 winner: team_3 vs. team_6
  p_game_3 = predict(elo_reg_season, data.frame(home = team_3, visitor = team_6))
  w_game_3 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_3, team_3, team_6)
  
  # Predict Game 4 winner: team_2 vs. team_7
  p_game_4 = predict(elo_reg_season, data.frame(home = team_2, visitor = team_7))
  w_game_4 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_4, team_2, team_7)
  
  
  ### SIMULATE THE SEMIFINALS
  
  # Predict Game 5 winner: winner Game 1 vs. winner Game 2
  p_game_5 = predict(elo_reg_season, data.frame(home = w_game_1, visitor = w_game_2))
  w_game_5 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_5, w_game_1, w_game_2)
  
  # Predict Game 6 winner: winner Game 3 vs. winner Game 4
  p_game_6 = predict(elo_reg_season, data.frame(home = w_game_4, visitor = w_game_3))
  w_game_6 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_6, w_game_4, w_game_3)
  
  
  ### SIMULATE THE FINALS
  
  # Predict Game 5 winner: winner Game 1 vs. winner Game 2
  p_game_7 = predict(elo_reg_season, data.frame(home = w_game_5, visitor = w_game_6))
  w_game_7 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_7, w_game_5, w_game_6)
  
  champion[i] = w_game_7
  
}</code></pre>
<p>Now I can compute the proportion of times each team “won” the state tournament.</p>
<pre class="r"><code>data.frame(champion) %&gt;% 
  group_by(champion) %&gt;%
  summarize(Probability = length(champion)/10000) %&gt;%
  arrange(desc(Probability))</code></pre>
<table>
<caption><span id="tab:unnamed-chunk-11">Table 4: </span>Probability that each of the eight Class A teams will win the state tournament.</caption>
<thead>
<tr class="header">
<th align="left">Team</th>
<th align="center">Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Hermantown</td>
<td align="center">0.1987</td>
</tr>
<tr class="even">
<td align="left">Mahtomedi</td>
<td align="center">0.1802</td>
</tr>
<tr class="odd">
<td align="left">Orono</td>
<td align="center">0.1612</td>
</tr>
<tr class="even">
<td align="left">Monticello</td>
<td align="center">0.1127</td>
</tr>
<tr class="odd">
<td align="left">Alexandria</td>
<td align="center">0.1086</td>
</tr>
<tr class="even">
<td align="left">Thief River Falls</td>
<td align="center">0.0939</td>
</tr>
<tr class="odd">
<td align="left">Mankato East</td>
<td align="center">0.0812</td>
</tr>
<tr class="even">
<td align="left">Litchfield/Dassel-Cokato</td>
<td align="center">0.0635</td>
</tr>
</tbody>
</table>
<p>Based on these simulations, Mahtomedi, Hermantown and Orono all have about an equal chance of winning the Class A tournament.</p>
<p>I also carried out a similar simulation for the Class AA tournament.</p>
<pre class="r"><code># Enter teams in rank order
team_1 = &quot;Minnetonka&quot;
team_2 = &quot;Edina&quot;
team_3 = &quot;Duluth East&quot;
team_4 = &quot;St. Thomas Academy&quot;
team_5 = &quot;Centennial&quot;
team_6 = &quot;STMA&quot;
team_7 = &quot;Lakeville North&quot;
team_8 = &quot;Hill-Murray&quot;

# Set up empty vector to store winner in
champion2 = rep(NA, 10000)


for(i in 1:10000){
  
  ### SIMULATE THE QUARTEFINALS
  
  # Predict Game 1 winner: team_1 vs. team_8
  p_game_1 = predict(elo_reg_season, data.frame(home = team_1, visitor = team_8))
  w_game_1 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_1, team_1, team_8)
  
  # Predict Game 2 winner: team_4 vs. team_4
  p_game_2 = predict(elo_reg_season, data.frame(home = team_4, visitor = team_5))
  w_game_2 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_2, team_4, team_5)
  
  # Predict Game 3 winner: team_3 vs. team_6
  p_game_3 = predict(elo_reg_season, data.frame(home = team_3, visitor = team_6))
  w_game_3 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_3, team_3, team_6)
  
  # Predict Game 4 winner: team_2 vs. team_7
  p_game_4 = predict(elo_reg_season, data.frame(home = team_2, visitor = team_7))
  w_game_4 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_4, team_2, team_7)
  
  
  ### SIMULATE THE SEMIFINALS
  
  # Predict Game 5 winner: winner Game 1 vs. winner Game 2
  p_game_5 = predict(elo_reg_season, data.frame(home = w_game_1, visitor = w_game_2))
  w_game_5 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_5, w_game_1, w_game_2)
  
  # Predict Game 6 winner: winner Game 3 vs. winner Game 4
  p_game_6 = predict(elo_reg_season, data.frame(home = w_game_4, visitor = w_game_3))
  w_game_6 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_6, w_game_4, w_game_3)
  
  
  ### SIMULATE THE FINALS
  
  # Predict Game 5 winner: winner Game 1 vs. winner Game 2
  p_game_7 = predict(elo_reg_season, data.frame(home = w_game_5, visitor = w_game_6))
  w_game_7 = ifelse(runif(1, min = 0, max = 1) &lt;= p_game_7, w_game_5, w_game_6)
  
  champion2[i] = w_game_7
  
}</code></pre>
<pre class="r"><code>data.frame(champion2) %&gt;% 
  group_by(champion2) %&gt;%
  summarize(Probability = length(champion2)/10000) %&gt;%
  arrange(desc(Probability))</code></pre>
<table>
<caption><span id="tab:unnamed-chunk-14">Table 5: </span>Probability that each of the eight Class AA teams will win the state tournament.</caption>
<thead>
<tr class="header">
<th align="left">Team</th>
<th align="center">Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">St. Thomas Academy</td>
<td align="center">0.2098</td>
</tr>
<tr class="even">
<td align="left">Edina</td>
<td align="center">0.2083</td>
</tr>
<tr class="odd">
<td align="left">Minnetonka</td>
<td align="center">0.1852</td>
</tr>
<tr class="even">
<td align="left">Duluth East</td>
<td align="center">0.1495</td>
</tr>
<tr class="odd">
<td align="left">STMA</td>
<td align="center">0.1016</td>
</tr>
<tr class="even">
<td align="left">Centennial</td>
<td align="center">0.0701</td>
</tr>
<tr class="odd">
<td align="left">Lakeville North</td>
<td align="center">0.0416</td>
</tr>
<tr class="even">
<td align="left">Hill-Murray</td>
<td align="center">0.0339</td>
</tr>
</tbody>
</table>
<p>The simulation results suggest that both Edina and St. Thomas Academy have a pretty good shot of winning the tournament, and Minnetonka and Duluth East are also in the mix.</p>
</div>
